<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ch·ªçn gh·∫ø ng·ªìi</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='images/icons8-ticket-50.png') }}" type="image/png">
    <style>
        body {
            background-color: #111;
            color: white;
            font-family: 'Arial', sans-serif;
            text-align: center;
            padding: 20px;
        }
        h2 {
            margin-bottom: 10px;
        }
        .screen {
            background: linear-gradient(135deg, #8B4513, #A0522D, #CD853F);
            color: white;
            padding: 15px;
            margin: 20px auto;
            width: 70%;
            border-radius: 8px;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 2px solid #DAA520;
        }
        .seat-row {
            display: flex;
            justify-content: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        .seat {
            width: 30px;
            height: 30px;
            margin: 3px;
            border-radius: 4px;
            line-height: 30px;
            text-align: center;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
        }
        .seat.vip {
            background-color: gold;
            color: black;
        }
        .seat.normal {
            background-color: #4CAF50;
        }
        .seat.selected {
            border: 3px solid #f00;
            box-shadow: 0 0 10px #f00;
        }
        #confirm-btn {
            margin-top: 30px;
            padding: 10px 25px;
            background: #ccc;
            color: black;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: not-allowed;
        }
        #confirm-btn.enabled {
            background: #28a745;
            color: white;
            cursor: pointer;
        }
        
        #vip-seats-container, #normal-seats-container {
            margin: 20px 0;
        }
        
        #vip-seats-container h3, #normal-seats-container h3 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        #normal-seats-container h3 {
            color: #4CAF50;
        }
        
        /* Header v√† Navigation styles cho theme t·ªëi */
        header {
            background-color: #222;
            border-bottom: 1px solid #444;
        }
        
        .nav {
            background-color: #333;
            border-bottom: 1px solid #555;
        }
        
        .nav a {
            color: #fff;
        }
        
        .nav a:hover {
            background-color: #555;
        }
        
        .auth-links a {
            color: #fff;
        }
        
        .header-actions a {
            color: #fff;
        }
    </style>
</head>
<body>
<header>
    <div class="logo">
        <a href="/"><img src="{{ url_for('static', filename='images/icons8-ticket-100.png') }}" alt="Ticketbox Logo"
                         class="logo-img"></a>
    </div>
    <form class="search-bar" method="get" action="/">
        <input type="text" name="q" value="{{ search }}" placeholder="B·∫°n t√¨m g√¨ h√¥m nay?">
        <button type="submit">T√¨m ki·∫øm</button>
    </form>

    <div class="header-actions">
        <a href="{{ url_for('event_organizer.create_event') }}" class="create-event">
            <span>T·∫°o s·ª± ki·ªán</span>
        </a>
        <a href="{{ url_for('events.my_tickets') }}" class="my-ticket">
            <img src="{{ url_for('static', filename='images/icons8-ticket-30.png') }}" alt="ticket icon"
                 class="ticket-icon">
            <span>V√© c·ªßa t√¥i</span>
        </a>
    </div>

    <div class="auth-links">
        {% if current_user %}
    üëã Xin ch√†o, <strong>{{ current_user.fullname }}</strong> |
    <a href="{{ url_for('auth.logout') }}">ƒêƒÉng xu·∫•t</a>
    {% else %}
    <a href="{{ url_for('auth.login') }}">ƒêƒÉng nh·∫≠p</a> |
    <a href="{{ url_for('auth.register') }}">ƒêƒÉng k√Ω</a>
    {% endif %}
    </div>
</header>

<div class="nav">
    <a href="{{ url_for('events.home', q='Nh·∫°c s·ªëng') }}">Nh·∫°c s·ªëng</a>
    <a href="{{ url_for('events.home', q='S√¢n kh·∫•u & Ngh·ªá thu·∫≠t') }}">S√¢n kh·∫•u & Ngh·ªá thu·∫≠t</a>
    <a href="{{ url_for('events.home', q='Th·ªÉ thao') }}">Th·ªÉ thao</a>
    <a href="{{ url_for('events.home', q='Kh√°c') }}">Kh√°c</a>
</div>

<h2>üéüÔ∏è Ch·ªçn gh·∫ø c·ªßa b·∫°n</h2>
{% if current_user %}
<div style="background: rgba(76, 175, 80, 0.2); border: 1px solid #4CAF50; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center;">
    <div style="color: #4CAF50; font-weight: bold; margin-bottom: 5px;">‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p</div>
    <div style="font-size: 14px;">Xin ch√†o <strong>{{ current_user.fullname }}</strong>, b·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c ch·ªçn gh·∫ø!</div>
</div>
{% endif %}
<div id="ticket-info" style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
    <h3 style="margin: 0 0 10px 0; color: #ffd700;">üìã Th√¥ng tin v√© ƒë√£ ch·ªçn:</h3>
    <div id="ticket-details"></div>
</div>
<div class="screen">S√ÇN KH·∫§U</div>

<!-- VIP SEATS -->
<div id="vip-seats-container">
    <!-- S·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông b·∫±ng JavaScript -->
</div>

<!-- NORMAL SEATS -->
<div id="normal-seats-container">
    <!-- S·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông b·∫±ng JavaScript -->
</div>

<button id="confirm-btn" disabled>Ti·∫øp t·ª•c</button>

<script>
    // ƒê·ªçc t·ª´ localStorage
    const selectedTickets = JSON.parse(localStorage.getItem("selectedTickets") || "{}");
    console.log("Selected tickets from localStorage:", selectedTickets); // Debug log
    
    const confirmBtn = document.getElementById('confirm-btn');
    const selectedSeats = [];
    let ticketInfoFromDB = {}; // S·∫Ω ch·ª©a th√¥ng tin v√© t·ª´ database (s·ªë v√© c√≤n l·∫°i)
    let totalSeatsFromDB = {}; // S·∫Ω ch·ª©a t·ªïng s·ªë gh·∫ø ban ƒë·∫ßu t·ª´ database
    let bookedSeats = [];
    
    // L·∫•y th√¥ng tin v√© t·ª´ database v√† t·∫°o gh·∫ø
    async function createSeats() {
        const vipContainer = document.getElementById('vip-seats-container');
        const normalContainer = document.getElementById('normal-seats-container');
        
        // L·∫•y event_id t·ª´ URL
        const pathParts = window.location.pathname.split('/');
        const eventId = pathParts[pathParts.length - 1];
        
        try {
            // L·∫•y th√¥ng tin v√© t·ª´ database (s·ªë v√© c√≤n l·∫°i)
            const response = await fetch(`/api/ticket-info/${eventId}`);
            const data = await response.json();
            
            if (data.success) {
                ticketInfoFromDB = data.ticket_info;
                console.log("Ticket info from DB (available):", ticketInfoFromDB);
            }
            
            // L·∫•y t·ªïng s·ªë gh·∫ø ban ƒë·∫ßu
            const totalSeatsResponse = await fetch(`/api/total-seats/${eventId}`);
            const totalSeatsData = await totalSeatsResponse.json();
            
            if (totalSeatsData.success) {
                totalSeatsFromDB = totalSeatsData.total_seats;
                console.log("Total seats from DB:", totalSeatsFromDB);
            }
        } catch (error) {
            console.error("Error fetching ticket info:", error);
        }
        
        // T√≠nh s·ªë l∆∞·ª£ng v√© VIP v√† th∆∞·ªùng t·ª´ localStorage (ƒë√£ ch·ªçn)
        const vipTickets = (selectedTickets["V√© VIP"] || 0) + (selectedTickets["V√© Premium"] || 0);
        const normalTickets = (selectedTickets["V√© Th∆∞·ªùng"] || 0) + (selectedTickets["V√© Standing"] || 0);
        
        // T√≠nh t·ªïng s·ªë v√© c√≥ s·∫µn t·ª´ database (s·ªë v√© c√≤n l·∫°i)
        let totalVipAvailable = 0;
        let totalNormalAvailable = 0;
        
        if (ticketInfoFromDB["V√© VIP"]) totalVipAvailable += ticketInfoFromDB["V√© VIP"];
        if (ticketInfoFromDB["V√© Premium"]) totalVipAvailable += ticketInfoFromDB["V√© Premium"];
        if (ticketInfoFromDB["V√© Th∆∞·ªùng"]) totalNormalAvailable += ticketInfoFromDB["V√© Th∆∞·ªùng"];
        if (ticketInfoFromDB["V√© Standing"]) totalNormalAvailable += ticketInfoFromDB["V√© Standing"];
        
        // T√≠nh t·ªïng s·ªë gh·∫ø ban ƒë·∫ßu t·ª´ database
        let totalVipSeats = 0;
        let totalNormalSeats = 0;
        
        if (totalSeatsFromDB["V√© VIP"]) totalVipSeats += totalSeatsFromDB["V√© VIP"];
        if (totalSeatsFromDB["V√© Premium"]) totalVipSeats += totalSeatsFromDB["V√© Premium"];
        if (totalSeatsFromDB["V√© Th∆∞·ªùng"]) totalNormalSeats += totalSeatsFromDB["V√© Th∆∞·ªùng"];
        if (totalSeatsFromDB["V√© Standing"]) totalNormalSeats += totalSeatsFromDB["V√© Standing"];
        
        console.log(`Creating seats: VIP selected=${vipTickets}, available=${totalVipAvailable}, total=${totalVipSeats}, Normal selected=${normalTickets}, available=${totalNormalAvailable}, total=${totalNormalSeats}`);
        
        // Hi·ªÉn th·ªã th√¥ng tin v√© ƒë√£ ch·ªçn v√† t·ªïng s·ªë gh·∫ø ban ƒë·∫ßu
        const ticketDetails = document.getElementById('ticket-details');
        let detailsHTML = '';
        
        if (totalVipSeats > 0) {
            detailsHTML += `<div style="margin: 5px 0;">üé´ V√© VIP: ${vipTickets} v√© (ƒë√£ ch·ªçn) / ${totalVipSeats} gh·∫ø t·ªïng c·ªông</div>`;
        }
        if (totalNormalSeats > 0) {
            detailsHTML += `<div style="margin: 5px 0;">üé´ V√© Th∆∞·ªùng: ${normalTickets} v√© (ƒë√£ ch·ªçn) / ${totalNormalSeats} gh·∫ø t·ªïng c·ªông</div>`;
        }
        
        ticketDetails.innerHTML = detailsHTML;
        
        // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ v√© n√†o ƒë∆∞·ª£c ch·ªçn
        if (vipTickets === 0 && normalTickets === 0) {
            vipContainer.innerHTML = `
                <div style="color: #ff6b6b; font-size: 18px; margin: 20px;">
                    ‚ö†Ô∏è Kh√¥ng c√≥ v√© n√†o ƒë∆∞·ª£c ch·ªçn. Vui l√≤ng quay l·∫°i trang ch·ªçn v√©.
                    <br><br>
                    <button onclick="window.history.back()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        ‚Üê Quay l·∫°i
                    </button>
                </div>`;
            normalContainer.innerHTML = '';
            return;
        }
        
        // L·∫•y danh s√°ch gh·∫ø ƒë√£ ƒë·∫∑t
        try {
            const bookedRes = await fetch(`/api/booked-seats/${eventId}`);
            const bookedData = await bookedRes.json();
            if (bookedData.success) {
                bookedSeats = bookedData.booked_seats || [];
            }
        } catch (e) { bookedSeats = []; }
        
        // T·∫°o gh·∫ø VIP d·ª±a tr√™n t·ªïng s·ªë gh·∫ø ban ƒë·∫ßu t·ª´ database
        if (totalVipSeats > 0) {
            vipContainer.innerHTML = '<h3>üé´ Gh·∫ø VIP</h3>';
            
            // S·ª≠ d·ª•ng t·ªïng s·ªë gh·∫ø VIP ban ƒë·∫ßu t·ª´ database
            const vipRows = Math.ceil(totalVipSeats / 30);
            
            console.log(`VIP seats from DB: ${totalVipSeats}, Creating: ${totalVipSeats} seats in ${vipRows} rows`);
            
            for (let row = 1; row <= vipRows; row++) {
                const seatRow = document.createElement('div');
                seatRow.className = 'seat-row';
                
                for (let col = 1; col <= 30; col++) {
                    const seatNum = (row - 1) * 30 + col;
                    if (seatNum <= totalVipSeats) {
                        const seatId = `V${row}-${col}`;
                        const seat = document.createElement('div');
                        seat.className = 'seat vip';
                        seat.dataset.seat = seatId;
                        seat.dataset.type = 'V√© VIP';
                        if (bookedSeats.includes(seatId)) {
                            seat.classList.add('booked');
                            seat.textContent = 'X';
                            seat.style.background = '#888';
                            seat.style.color = '#fff';
                            seat.style.cursor = 'not-allowed';
                        } else {
                            seat.textContent = seatId;
                        }
                        seatRow.appendChild(seat);
                    }
                }
                vipContainer.appendChild(seatRow);
            }
        }
        
        // T·∫°o gh·∫ø th∆∞·ªùng d·ª±a tr√™n t·ªïng s·ªë gh·∫ø ban ƒë·∫ßu t·ª´ database
        if (totalNormalSeats > 0) {
            normalContainer.innerHTML = '<h3>üé´ Gh·∫ø Th∆∞·ªùng</h3>';
            
            // S·ª≠ d·ª•ng t·ªïng s·ªë gh·∫ø th∆∞·ªùng ban ƒë·∫ßu t·ª´ database
            const normalRows = Math.ceil(totalNormalSeats / 30);
            
            console.log(`Normal seats from DB: ${totalNormalSeats}, Creating: ${totalNormalSeats} seats in ${normalRows} rows`);
            
            for (let row = 1; row <= normalRows; row++) {
                const seatRow = document.createElement('div');
                seatRow.className = 'seat-row';
                
                for (let col = 1; col <= 30; col++) {
                    const seatNum = (row - 1) * 30 + col;
                    if (seatNum <= totalNormalSeats) {
                        const seatId = `T${row}-${col}`;
                        const seat = document.createElement('div');
                        seat.className = 'seat normal';
                        seat.dataset.seat = seatId;
                        seat.dataset.type = 'V√© Th∆∞·ªùng';
                        if (bookedSeats.includes(seatId)) {
                            seat.classList.add('booked');
                            seat.textContent = 'X';
                            seat.style.background = '#888';
                            seat.style.color = '#fff';
                            seat.style.cursor = 'not-allowed';
                        } else {
                            seat.textContent = seatId;
                        }
                        seatRow.appendChild(seat);
                    }
                }
                normalContainer.appendChild(seatRow);
            }
        }
        
        // Th√™m event listeners cho c√°c gh·∫ø m·ªõi
        addSeatEventListeners();
    }
    
    // Th√™m event listeners cho t·∫•t c·∫£ gh·∫ø
    function addSeatEventListeners() {
        const seatElements = document.querySelectorAll('.seat');
        seatElements.forEach(seat => {
            if (!seat.classList.contains('booked')) {
                seat.addEventListener('click', () => updateSelection(seat));
            }
        });
    }
    
    // T·∫°o gh·∫ø khi trang load
    createSeats().catch(error => {
        console.error("Error creating seats:", error);
    });

    function updateSelection(seatEl) {
        const seatType = seatEl.dataset.type;
        const seatId = seatEl.dataset.seat;
        const selectedOfType = selectedSeats.filter(s => s.type === seatType);
        
        // T√¨m s·ªë l∆∞·ª£ng v√© t∆∞∆°ng ·ª©ng t·ª´ selectedTickets
        let maxAllowed = 0;
        if (seatType === "V√© VIP") {
            // Ki·ªÉm tra c√°c lo·∫°i v√© VIP kh√°c nhau
            maxAllowed = selectedTickets["V√© VIP"] || selectedTickets["V√© Premium"] || 0;
        } else if (seatType === "V√© Th∆∞·ªùng") {
            // Ki·ªÉm tra c√°c lo·∫°i v√© th∆∞·ªùng kh√°c nhau
            maxAllowed = selectedTickets["V√© Th∆∞·ªùng"] || selectedTickets["V√© Standing"] || 0;
        }
        
        console.log(`Seat: ${seatId}, Type: ${seatType}, Max allowed: ${maxAllowed}, Currently selected: ${selectedOfType.length}`); // Debug log

        if (seatEl.classList.contains('selected')) {
            seatEl.classList.remove('selected');
            const index = selectedSeats.findIndex(s => s.id === seatId);
            if (index > -1) selectedSeats.splice(index, 1);
        } else {
            if (selectedOfType.length < maxAllowed) {
                seatEl.classList.add('selected');
                selectedSeats.push({ id: seatId, type: seatType });
            } else {
                alert(`Ch·ªâ ƒë∆∞·ª£c ch·ªçn ${maxAllowed} gh·∫ø lo·∫°i ${seatType}`);
            }
        }

        // T√≠nh t·ªïng s·ªë gh·∫ø c·∫ßn ch·ªçn d·ª±a tr√™n mapping
        let totalRequired = 0;
        if (selectedTickets["V√© VIP"] || selectedTickets["V√© Premium"]) {
            totalRequired += (selectedTickets["V√© VIP"] || 0) + (selectedTickets["V√© Premium"] || 0);
        }
        if (selectedTickets["V√© Th∆∞·ªùng"] || selectedTickets["V√© Standing"]) {
            totalRequired += (selectedTickets["V√© Th∆∞·ªùng"] || 0) + (selectedTickets["V√© Standing"] || 0);
        }
        
        console.log(`Total required: ${totalRequired}, Currently selected: ${selectedSeats.length}`); // Debug log
        
        if (selectedSeats.length === totalRequired && totalRequired > 0) {
            confirmBtn.classList.add('enabled');
            confirmBtn.disabled = false;
            console.log("‚úÖ Confirm button enabled");
        } else {
            confirmBtn.classList.remove('enabled');
            confirmBtn.disabled = true;
            console.log("‚ùå Confirm button disabled");
        }
    }

    confirmBtn.addEventListener('click', () => {
        console.log("üîò Confirm button clicked!");
        
        // L·∫•y event_id t·ª´ URL
        const pathParts = window.location.pathname.split('/');
        const eventId = pathParts[pathParts.length - 1];
        
        console.log("üìã Event ID:", eventId);
        console.log("üé´ Selected seats:", selectedSeats);
        console.log("üéüÔ∏è Selected tickets:", selectedTickets);
        
        // Ki·ªÉm tra d·ªØ li·ªáu tr∆∞·ªõc khi g·ª≠i
        if (selectedSeats.length === 0) {
            alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt gh·∫ø!");
            return;
        }
        
        const requestData = { 
            seats: selectedSeats,
            event_id: parseInt(eventId),
            selected_tickets: selectedTickets
        };
        
        console.log("üì§ Sending request data:", requestData);
        
        fetch("/confirm-seats", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData)
        })
        .then(res => {
            console.log("üì• Response status:", res.status);
            console.log("üì• Response headers:", res.headers);
            return res.json();
        })
        .then(data => {
            console.log("üì• Response data:", data);
            if (data.success) {
                // Chuy·ªÉn ƒë·∫øn trang thanh to√°n thay v√¨ my-tickets
                const redirectUrl = data.redirect_url || `/payment/${eventId}`;
                console.log("üîÑ Redirecting to:", redirectUrl);
                window.location.href = redirectUrl;
            } else {
                if (data.message && data.message.includes('ƒëƒÉng nh·∫≠p')) {
                    // N·∫øu l·ªói ƒëƒÉng nh·∫≠p, chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p
                    alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
                    window.location.href = '{{ url_for("auth.login") }}';
                } else {
                    alert("L·ªói: " + data.message);
                }
            }
        })
        .catch(error => {
            console.error("‚ùå Error:", error);
            alert("C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω y√™u c·∫ßu!");
        });
    });
</script>

<!-- Footer v·ªõi b·∫£n quy·ªÅn -->
<footer class="footer">
    <div class="footer-content">
        <div class="footer-section">
            <h3>TicketBox Clone</h3>
            <p>H·ªá th·ªëng ƒë·∫∑t v√© s·ª± ki·ªán tr·ª±c tuy·∫øn</p>
        </div>
        <div class="footer-section">
            <h4>Li√™n h·ªá</h4>
            <p>Email: info@ticketboxclone.com</p>
            <p>ƒêi·ªán tho·∫°i: 1900-xxxx</p>
        </div>
        <div class="footer-section">
            <h4>Theo d√µi</h4>
            <p>Facebook | Instagram | Twitter</p>
        </div>
    </div>
    <div class="footer-bottom">
        <p>&copy; 2024 TicketBox Clone. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
        <p>Ph√°t tri·ªÉn b·ªüi QLDAPM Team</p>
    </div>
</footer>

<script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>
