{% extends "event_organizer/layout_event_organizer/base.html" %}

{% block title %}Quét mã sự kiện{% endblock %}

{% block content %}
<div class="qr-container">
    <h2 class="qr-title">Quét mã sự kiện</h2>
    <div id="reader"></div>
    <div id="result" class="qr-result"></div>
</div>

<script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
<script>
    function onScanSuccess(decodedText, decodedResult) {
        const resultEl = document.getElementById("result");

        // Tạm dừng scanner để tránh quét liên tục
        html5QrcodeScanner.pause();

        // Hiển thị trạng thái đang xử lý
        resultEl.innerHTML = "Đang kiểm tra vé...";

        fetch("/organizer/api/booking/check-in", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ qr_code: decodedText })
        })
        .then(res => res.json())
        .then(data => {
            setTimeout(() => {
                if (data.success) {
                    resultEl.innerHTML = "Check-in thành công!";
                } else {
                    resultEl.innerHTML =data.message;
                }

                // Delay 2 giây nữa mới resume scanner
                setTimeout(() => {
                    resultEl.innerHTML = ""; // xóa thông báo
                    html5QrcodeScanner.resume();
                }, 2000);
            }, 1500); // 1.5 giây delay trước khi hiển thị kết quả
        })
        .catch(() => {
            setTimeout(() => {
                resultEl.innerHTML = "Lỗi kết nối server!";
                setTimeout(() => {
                    resultEl.innerHTML = "";
                    html5QrcodeScanner.resume();
                }, 2000);
            }, 1500);
        });
    }

    function onScanFailure(error) {}

    let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", { fps: 10, qrbox: 300 }
    );
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
</script>
{% endblock %}
